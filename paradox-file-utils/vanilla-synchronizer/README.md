
# Vanilla Synchronizer

A tool for Crusader Kings III modders to easily synchronize and update modded files with the latest vanilla game files, while preserving changes to top-level entities and their comments.

## What Does It Do?

- **Synchronizes** your modded files with the latest vanilla files from the game.
- **Preserves** your custom events (by key) and custom comments (using a configurable prefix).
- **Automatically merges** new vanilla content, so you can painlessly update your mod after a Paradox patch.
- **Uses a robust parser** (ANTLR-based) to accurately identify and swap event blocks, not just lines.

## How It Works

1. **Reads your configuration** from `sync-config.yaml` (or whatever you call it, look at `sync-config.example.yaml` for example options).
2. **Parses** both the vanilla and modded files using a custom Go parser generated from the Paradox Script grammar.
3. **For each file** listed in the config:
    - Copies all vanilla content.
    - Replaces any event blocks (e.g. `birth.1001 = { ... }`) with your modded version if you have one.
    - Maintains your custom comments (with your chosen prefix) above the relevant modded events.
    - Writes the merged result to a new file in `sync-output/`.

## Quick Start

### 1. Clone the Repository

```sh
git clone https://github.com/YOURUSERNAME/ck3-quieter-events.git
cd ck3-quieter-events/paradox-file-utils/vanilla-synchronizer
```

### 2. Prepare Your Config

Rename the example config and edit it for your setup:

e.g.
```sh
cp sync-config.example.yaml sync-config.yaml
```

- Edit `sync-config.yaml` and set:
    - `game_root`: Path to your CK3 game directory
    - `mod_root`: Path to the repo root/wherever your modded files are
    - `custom_comment_prefix`: Prefix for your custom comments inside the files you wish to keep (Only works for standalone line comments above top-level entity blocks (events/histories/etc.)
    - `files`: List of files and the keys of your modded entities you want to preserve

### 3. Build the Synchronizer

#### Option A: Using Make (Linux/macOS/WSL)

```sh
make build
```

This will build the `vanilla-synchronizer` binary.

#### Option B: Using Go Directly

```sh
go build -o vanilla-synchronizer vanilla_synchronizer.go
```

### 4. Run the Synchronizer

```sh
./vanilla-synchronizer sync-config.yaml
```

- The merged files will be written to the `sync-output/` directory.

---

### Example `sync-config.yaml`

```yaml
game_root: "/path/to/CK3/game"
mod_root: "/path/to/your/mod"
custom_comment_prefix: "# QUIETER:"
files:
  - relative_path: birth_events.txt
    modified_entity_keys:
      - birth.1001
      - birth.9004
  # Add more files and event keys as needed
```

## Troubleshooting

- **Config not working?**:
  - Make sure you renamed and edited `sync-config.example.yaml`.
- **Can't seem to find your files?**:
  - Ensure that both the game root path and mod paths are absolute or Go will likely fail to find them. 
  - Also make sure that the `relative_path` in the config is based on the files path in the game root dir, your modded versions should mirror that structure.
- **Comments From Mod files Not Preserved?**: 
  - Ensure your `custom_comment_prefix` matches exactly (including spaces and `#`) what you use in your mod files. Note that only comments just above modded entities will be preserved, multiling comments are supported though as long as prefix is on all lines.
- **Parser errors?**:
  - Make sure your files are valid Paradox script and encoded as UTF-8 with BOM. If they are and you still have errors message me or open an issue.

## Parser Information

- The synchronizer uses a **Go parser generated by ANTLR** for Paradox Script Language located in [`../parser/`](../parser/).
- This parser pretty accurately understands Paradox event syntax, including nested blocks, assignments, and comments.
- Currently It's based only on grammar need to work with event files, it should work with most other game files but **I have not tested any non-event files** to know for sure. This is definitely something that can be extended so please feel free to PR or message me with requests.
- If you want to see another example of something using this parser look at [`../examples/getting-events.go`](../examples/getting-events.go) where I wrote a smaller script that travers a given event file and outputs all the event blocks and the total number of events in the file. There's so much more you can do though.

## Contributing

Pull requests and issues are welcome!  
If you want to extend the parser or add new features, see the `parser/` directory for the ANTLR grammar and Go integration.


## License

MIT